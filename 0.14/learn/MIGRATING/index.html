<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CosmWasm Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CosmWasm Documentation Blog Atom Feed"><title data-react-helmet="true">Migrating Contracts | CosmWasm Documentation</title><meta data-react-helmet="true" property="og:url" content="https://test-docs.cosmwasm.com/0.14/learn/MIGRATING"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Migrating Contracts | CosmWasm Documentation"><meta data-react-helmet="true" name="description" content="This guide explains what is needed to upgrade contracts when migrating over"><meta data-react-helmet="true" property="og:description" content="This guide explains what is needed to upgrade contracts when migrating over"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.svg"><link data-react-helmet="true" rel="canonical" href="https://test-docs.cosmwasm.com/0.14/learn/MIGRATING"><link data-react-helmet="true" rel="alternate" href="https://test-docs.cosmwasm.com/0.14/learn/MIGRATING" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://test-docs.cosmwasm.com/0.14/learn/MIGRATING" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.2a394334.css">
<link rel="preload" href="/assets/js/runtime~main.74a0419b.js" as="script">
<link rel="preload" href="/assets/js/main.435ff634.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a><a class="navbar__item navbar__link" href="/0.14/">0.14</a></div><div class="navbar__items navbar__items--right"><a href="https://cosmwasm.com" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Website</a><a href="https://github.com/CosmWasm" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="CosmWasm" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a href="https://cosmwasm.com" target="_blank" rel="noopener noreferrer" class="menu__link">Website</a></li><li class="menu__list-item"><a href="https://github.com/CosmWasm" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link">Versions</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Welcome</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/introduction/roadmap">Rough Roadmap</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/intro">Your First Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/setting-env">Setting Up Environment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/compile-contract">Downloading and Compiling Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/interact-with-contract">Uploading and Interacting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/getting-started/next-steps">Next Steps</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Architecture</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/multichain">What are Multi-Chain Contracts?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/actor">Actor Model for Contract Calls</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/addresses">Names and Addresses</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/query">Querying Contract State</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/serialization">Serialization Formats</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/composition">Contract Composition</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/architecture/smart-contracts">Comparison with Solidity Contracts</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Testnets</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/testnets/build-requirements">Build Requirements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/testnets/testnets">Joining Testnets</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Learn</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Simple Option</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/simple-option/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/simple-option/setup">Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/simple-option/develop">Develop Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/simple-option/testing">Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/simple-option/next-steps">Next Steps</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Hijack Escrow</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/hijack-escrow/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/hijack-escrow/hack-contract">Hack the Contract</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/hijack-escrow/edit-escrow-hints">Hints</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/0.14/learn/governance">Smart Contracts Over Governance</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Name Service</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/name-service/intro">Introduction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="0">Frontend dApp</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/frontend-dapp/intro">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/frontend-dapp/cosmicdapp-logic">Cosmic dApp logic</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/frontend-dapp/cosmicdapp-design">Cosmic dApp design</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/frontend-dapp/bootstrap-dapp">Bootstrap dApp</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/learn/frontend-dapp/dapp-development">Develop dApp</a></li></ul></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/0.14/learn/videos-workshops">Videos and Workshops</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/0.14/learn/MIGRATING">Migrating Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/0.14/learn/CHANGELOG">CHANGELOG</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Community</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/community/hall-of-fame">Hall of Fame</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Plus Contracts</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW1</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw1/intro">CW1 Spec: Proxy Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw1/cw1-subkeys">CW1 Subkeys</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw1/cw1-whitelist">CW1 Whitelist</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW2</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw2/Spec">CW2 Spec: Contract Info for Migration</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW3</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw3/spec">CW3 Spec: MultiSig/Voting Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw3/cw3-fixed-spec">CW3 Fixed Multisig</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw3/cw3-flex-spec">CW3 Flexible Multisig</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW4</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw4/spec">CW4 Spec: Group Members</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw4/cw4-group-spec">CW4 Group</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw4/cw4-stake-spec">CW4 Stake</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW20</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/spec">CW20 Spec: Fungible Tokens</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-base-spec">CW20 Basic</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-base-tutorial">CW20-base Tutorial</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-bonding-spec">CW20 Bonding curve</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-escrow-spec">CW20 Escrow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-staking-spec">CW20 Staking Derivates</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw20/cw20-atomic-swap-spec">Atomic Swaps</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">CW721</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw721/spec">CW721 Spec: Non Fungible Tokens</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/cw721/cw721-base">Cw721 Basic</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">General</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/general/overview">Plus Contracts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/cw-plus/general/tips">Advanced REPL tips</a></li></ul></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">IBC</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/ibc/overview">IBC And CosmWasm</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/ibc/relayer">Relayer</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/ibc/active-connections">Active IBC connections</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/ibc/cw20-ics20">CW20 ICS20</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Resources</a><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!" tabindex="-1">Media</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/0.14/resources/media/assets">Brand guidelines</a></li></ul></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Migrating Contracts</h1></header><div class="markdown"><p>This guide explains what is needed to upgrade contracts when migrating over
major releases of <code>cosmwasm</code>. Note that you can also view the
<a href="/0.14/learn/CHANGELOG">complete CHANGELOG</a> to understand the differences.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="013---014"></a>0.13 -&gt; 0.14<a class="hash-link" href="#013---014" title="Direct link to heading">#</a></h2><ul><li><p>The minimum Rust supported version for 0.14 is 1.51.0. Verify your Rust
version is &gt;= 1.51.0 with: <code>rustc --version</code></p></li><li><p>Update CosmWasm and schemars dependencies in Cargo.toml (skip the ones you
don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.14.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.14.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">schemars = &quot;0.8.1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.14.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.14.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Rename the <code>init</code> entry point to <code>instantiate</code>. Also, rename <code>InitMsg</code> to
<code>InstantiateMsg</code>.</p></li><li><p>Rename the <code>handle</code> entry point to <code>execute</code>. Also, rename <code>HandleMsg</code> to
<code>ExecuteMsg</code>.</p></li><li><p>Rename <code>InitResponse</code>, <code>HandleResponse</code> and <code>MigrateResponse</code> to <code>Response</code>.
The old names are still supported (with a deprecation warning), and will be
removed in the next version. Also, you&#x27;ll need to add the <code>submessages</code> field
to <code>Response</code>.</p></li><li><p>Remove <code>from_address</code> from <code>BankMsg::Send</code>, which is now automatically filled
with the contract address:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    from_address: env.contract.address,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_address: to_addr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    amount: balance,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_address: to_addr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    amount: balance,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">});</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Use the new entry point system. From <code>lib.rs</code> remove</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[cfg(target_arch = &quot;wasm32&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm_std::create_entry_points!(contract);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// or</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[cfg(target_arch = &quot;wasm32&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm_std::create_entry_points_with_migration!(contract);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then add the macro attribute <code>#[entry_point]</code> to your <code>contract.rs</code> as
follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use cosmwasm_std::{entry_point, â€¦ };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[entry_point]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _deps: DepsMut,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _info: MessageInfo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _msg: InitMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; StdResult&lt;Response&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[entry_point]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn execute(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _deps: DepsMut,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _info: MessageInfo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _msg: ExecuteMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; StdResult&lt;Response&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// only if you have migrate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[entry_point]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn migrate(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: DepsMut,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _info: MessageInfo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: MigrateMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; StdResult&lt;Response&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[entry_point]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn query(_deps: Deps, _env: Env, _msg: QueryMsg) -&gt; StdResult&lt;QueryResponse&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Since <code>Response</code> contains a <code>data</code> field, converting <code>Context</code> into <code>Response</code>
always succeeds.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init(deps: DepsMut, env: Env, info: MessageInfo, msg: InitMsg) -&gt; Result&lt;InitResponse, HackError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_attribute(&quot;Let the&quot;, &quot;hacking begin&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(ctx.try_into()?)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init(deps: DepsMut, env: Env, info: MessageInfo, msg: InitMsg) -&gt; Result&lt;Response, HackError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_attribute(&quot;Let the&quot;, &quot;hacking begin&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(ctx.into())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Remove the <code>info: MessageInfo</code> field from the <code>migrate</code> entry point:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn migrate(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: DepsMut,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _info: MessageInfo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: MigrateMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; StdResult&lt;MigrateResponse&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// After</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn migrate(deps: DepsMut, env: Env, msg: MigrateMsg) -&gt; StdResult&lt;Response&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p><code>MessageInfo::funds</code> was always empty since [MsgMigrateContract] does not have
a funds field. <code>MessageInfo::sender</code> should not be needed for authentication
because the chain checks permissions before calling <code>migrate</code>. If the sender&#x27;s
address is needed for anything else, this should be expressed as part of the
migrate message.</p><p>msgmigratecontract:
<a href="https://github.com/CosmWasm/wasmd/blob/v0.15.0/x/wasm/internal/types/tx.proto#L86-L96" target="_blank" rel="noopener noreferrer">https://github.com/CosmWasm/wasmd/blob/v0.15.0/x/wasm/internal/types/tx.proto#L86-L96</a></p></li><li><p>Add mutating helper methods to <code>Response</code> that can be used instead of creating
a <code>Context</code> that is later converted to a response:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn handle_impl(deps: DepsMut, env: Env, info: MessageInfo) -&gt; Result&lt;Response, ContractError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // release counter_offer to creator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_address: state.creator,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        amount: state.counter_offer,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // release collateral to sender</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_address: state.owner,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        amount: state.collateral,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // ..</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_attribute(&quot;action&quot;, &quot;execute&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(ctx.into())</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>  // after
pub fn execute_impl(deps: DepsMut, env: Env, info: MessageInfo) -&gt; Result&lt;Response, ContractError&gt; {
// ...</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // release counter_offer to creator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  let mut resp = Response::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resp.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_address: state.creator,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      amount: state.counter_offer,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // release collateral to sender</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resp.add_message(BankMsg::Send {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_address: state.owner,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      amount: state.collateral,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  });</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // ..</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  resp.add_attribute(&quot;action&quot;, &quot;execute&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Ok(resp)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>  }</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">- Use type `Pair` instead of `KV`</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">```rust</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use cosmwasm_std::KV;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use cosmwasm_std::Pair;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><ul><li><p>If necessary, add a wildcard arm to the <code>match</code> of now non-exhaustive message
types <code>BankMsg</code>, <code>BankQuery</code>, <code>WasmMsg</code> and <code>WasmQuery</code>.</p></li><li><p><code>HumanAddr</code> has been deprecated in favour of simply <code>String</code>. It never added
any significant safety bonus over <code>String</code> and was just a marker type. The new
type <code>Addr</code> was created to hold validated addresses. Those can be created via
<code>Addr::unchecked</code>, <code>Api::addr_validate</code>, <code>Api::addr_humanize</code> and JSON
deserialization. In order to maintain type safety, deserialization into <code>Addr</code>
must only be done from trusted sources like a contract&#x27;s state or a query
response. User inputs must be deserialized into <code>String</code>. This new <code>Addr</code> type
makes it easy to use human readable addresses in state:</p><p>With pre-validated <code>Addr</code> from <code>MessageInfo</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub owner: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let state = State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    owner: deps.api.canonical_address(&amp;info.sender /* of type HumanAddr */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>  // after
pub struct State {
pub owner: Addr,
}
let state = State {
owner: info.sender.clone() /<em> of type Addr </em>/,
};</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">With user input in `msg`:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">```rust</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub verifier: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub beneficiary: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub funder: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deps.storage.set(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CONFIG_KEY,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;to_vec(&amp;State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        verifier: deps.api.canonical_address(&amp;msg.verifier /* of type HumanAddr */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        beneficiary: deps.api.canonical_address(&amp;msg.beneficiary /* of type HumanAddr */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        funder: deps.api.canonical_address(&amp;info.sender /* of type HumanAddr */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub struct State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub verifier: Addr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub beneficiary: Addr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    pub funder: Addr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deps.storage.set(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    CONFIG_KEY,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    &amp;to_vec(&amp;State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        verifier: deps.api.addr_validate(&amp;msg.verifier /* of type String */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        beneficiary: deps.api.addr_validate(&amp;msg.beneficiary /* of type String */)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        funder: info.sender /* of type Addr */,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    })?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>  The existing <code>CanonicalAddr</code> remains unchanged and can be used in cases in
which a compact binary representation is desired. For JSON state this does not
save much data (e.g. the bech32 address
cosmos1pfq05em6sfkls66ut4m2257p7qwlk448h8mysz takes 45 bytes as direct ASCII
and 28 bytes when its canonical representation is base64 encoded). For fixed
length database keys <code>CanonicalAddr</code> remains handy though.</p><ul><li><p>Replace <code>StakingMsg::Withdraw</code> with <code>DistributionMsg::SetWithdrawAddress</code> and
<code>DistributionMsg::WithdrawDelegatorReward</code>. <code>StakingMsg::Withdraw</code> was a
shorthand for the two distribution messages. However, it was unintuitive
because it did not set the address for one withdraw only but for all following
withdrawls. Since withdrawls are <a href="https://docs.cosmos.network/v0.42/modules/distribution/" target="_blank" rel="noopener noreferrer">triggered by different
events</a> such as validators changing their commission rate,
an address that was set for a one-time withdrawl would be used for future
withdrawls not considered by the contract author.</p><p>If the contract never set a withdraw address other than the contract itself
(<code>env.contract.address</code>), you can simply replace <code>StakingMsg::Withdraw</code> with
<code>DistributionMsg::WithdrawDelegatorReward</code>. It is then never changed from the
default. Otherwise you need to carefully track what the current withdraw
address is. A one-time change can be implemented by emitted 3 messages:</p><ol><li><code>SetWithdrawAddress { address: recipient }</code> to temporarily change the
recipient</li><li><code>WithdrawDelegatorReward { validator }</code> to do a manual withdrawl from the
given validator</li><li><code>SetWithdrawAddress { address: env.contract.address.into() }</code> to change it
back for all future withdrawls</li></ol></li><li><p>The block time in <code>env.block.time</code> is now a <code>Timestamp</code> which stores
nanosecond precision. <code>env.block.time_nanos</code> was removed. If you need the
compnents as before, use</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let seconds = env.block.time.nanos() / 1_000_000_000;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let nsecs = env.block.time.nanos() % 1_000_000_000;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="012---013"></a>0.12 -&gt; 0.13<a class="hash-link" href="#012---013" title="Direct link to heading">#</a></h2><ul><li><p>The minimum Rust supported version for 0.13 is 1.47.0.</p><p>Verify your Rust version is &gt;= 1.47.0:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">rustc -V</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Update CosmWasm dependencies in Cargo.toml (skip the ones you don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.13.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.13.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.13.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.13.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="011---012"></a>0.11 -&gt; 0.12<a class="hash-link" href="#011---012" title="Direct link to heading">#</a></h2><ul><li><p>Update CosmWasm dependencies in Cargo.toml (skip the ones you don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.12.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.12.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.12.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.12.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>In your contract&#x27;s <code>.cargo/config</code> remove <code>--features backtraces</code>, which is
now available in Rust nightly only:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly diff"><div tabindex="0" class="prism-code language-diff codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token coord">@@ -1,6 +1,6 @@</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">[alias]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">wasm = &quot;build --release --target wasm32-unknown-unknown&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">wasm-debug = &quot;build --target wasm32-unknown-unknown&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgb(255, 85, 114)">-</span><span class="token deleted-sign deleted line" style="color:rgb(255, 85, 114)">unit-test = &quot;test --lib --features backtraces&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token deleted-sign deleted line" style="color:rgb(255, 85, 114)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(195, 232, 141)">+</span><span class="token inserted-sign inserted line" style="color:rgb(195, 232, 141)">unit-test = &quot;test --lib&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token inserted-sign inserted line" style="color:rgb(195, 232, 141)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">integration-test = &quot;test --test integration&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">schema = &quot;run --example schema&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>In order to use backtraces for debugging, run
<code>RUST_BACKTRACE=1 cargo +nightly unit-test --features backtraces</code>.</p></li><li><p>Rename the type <code>Extern</code> to <code>Deps</code>, and radically simplify the
<code>init</code>/<code>handle</code>/<code>migrate</code>/<code>query</code> entrypoints. Rather than
<code>&amp;mut Extern&lt;S, A, Q&gt;</code>, use <code>DepsMut</code>. And instead of <code>&amp;Extern&lt;S, A, Q&gt;</code>, use
<code>Deps</code>. If you ever pass eg. <code>foo&lt;A: Api&gt;(api: A)</code> around, you must now use
dynamic trait pointers: <code>foo(api: &amp;dyn Api)</code>. Here is the quick search-replace
guide on how to fix <code>contract.rs</code>:</p><p><em>In production (non-test) code:</em></p><ul><li><code>&lt;S: Storage, A: Api, Q: Querier&gt;</code> =&gt; ``</li><li><code>&amp;mut Extern&lt;S, A, Q&gt;</code> =&gt; <code>DepsMut</code></li><li><code>&amp;Extern&lt;S, A, Q&gt;</code> =&gt; <code>Deps</code></li><li><code>&amp;mut deps.storage</code> =&gt; <code>deps.storage</code> where passing into <code>state.rs</code> helpers</li><li><code>&amp;deps.storage</code> =&gt; <code>deps.storage</code> where passing into <code>state.rs</code> helpers</li></ul><p>On the top, remove <code>use cosmwasm_std::{Api, Extern, Querier, Storage}</code>. Add
<code>use cosmwasm_std::{Deps, DepsMut}</code>.</p><p><em>In test code only:</em></p><ul><li><code>&amp;mut deps,</code> =&gt; <code>deps.as_mut(),</code></li><li><code>&amp;deps,</code> =&gt; <code>deps.as_ref(),</code></li></ul><p>You may have to add <code>use cosmwasm_std::{Storage}</code> if the compile complains
about the trait</p><p><em>If you use cosmwasm-storage, in <code>state.rs</code>:</em></p><ul><li><code>&lt;S: Storage&gt;</code> =&gt; ``</li><li><code>&lt;S: ReadonlyStorage&gt;</code> =&gt; ``</li><li><code>&lt;S,</code> =&gt; <code>&lt;</code></li><li><code>&amp;mut S</code> =&gt; <code>&amp;mut dyn Storage</code></li><li><code>&amp;S</code> =&gt; <code>&amp;dyn Storage</code></li></ul></li><li><p>If you have any references to <code>ReadonlyStorage</code> left after the above, please
replace them with <code>Storage</code></p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="010---011"></a>0.10 -&gt; 0.11<a class="hash-link" href="#010---011" title="Direct link to heading">#</a></h2><ul><li><p>Update CosmWasm dependencies in Cargo.toml (skip the ones you don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.11.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.11.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.11.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.11.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Contracts now support any custom error type <code>E: ToString + From&lt;StdError&gt;</code>.
Previously this has been <code>StdError</code>, which you can still use. However, you can
now create a much more structured error experience for your unit tests that
handels exactly the error cases of your contract. In order to get a convenient
implementation for <code>ToString</code> and <code>From&lt;StdError&gt;</code>, we use the crate
<a href="https://crates.io/crates/thiserror" target="_blank" rel="noopener noreferrer">thiserror</a>, which needs to be added to
the contracts dependencies in <code>Cargo.toml</code>. To create the custom error, create
an error module <code>src/errors.rs</code> as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">use cosmwasm_std::{CanonicalAddr, StdError};</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">use thiserror::Error;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// thiserror implements Display and ToString if you</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// set the `#[error(&quot;â€¦&quot;)]` attribute for all cases</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[derive(Error, Debug)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub enum MyCustomError {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[error(&quot;{0}&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // let thiserror implement From&lt;StdError&gt; for you</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Std(#[from] StdError),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // this is whatever we want</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[error(&quot;Permission denied: the sender is not the current owner&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    NotCurrentOwner {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        expected: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        actual: CanonicalAddr,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    },</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #[error(&quot;Messages empty. Must reflect at least one message&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    MessagesEmpty,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then add <code>mod errors;</code> to <code>src/lib.rs</code> and <code>use crate::errors::MyCustomError;</code>
to <code>src/contract.rs</code>. Now adapt the return types as follows:</p><ul><li><code>fn init</code>: <code>Result&lt;InitResponse, MyCustomError&gt;</code>,</li><li><code>fn migrate</code> (if you have it): <code>Result&lt;MigrateResponse, MyCustomError&gt;</code>,</li><li><code>fn handle</code>: <code>Result&lt;HandleResponse, MyCustomError&gt;</code>,</li><li><code>fn query</code>: <code>Result&lt;Binary, MyCustomError&gt;</code>.</li></ul><p>If one of your funtions does not use the custom error, you can continue to use
<code>StdError</code> as before. I.e. you can have <code>handle</code> returning
<code>Result&lt;HandleResponse, MyCustomError&gt;</code> and <code>query</code> returning
<code>StdResult&lt;Binary&gt;</code>.</p><p>You can have a top-hevel <code>init</code>/<code>migrate</code>/<code>handle</code>/<code>query</code> that returns a
custom error but some of its implementations only return errors from the
standard library (<code>StdResult&lt;HandleResponse&gt;</code> aka.
<code>Result&lt;HandleResponse, StdError&gt;</code>). Then use <code>Ok(std_result?)</code> to convert
between the result types. E.g.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn handle&lt;S: Storage, A: Api, Q: Querier&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: &amp;mut Extern&lt;S, A, Q&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: HandleMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; Result&lt;HandleResponse, StakingError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    match msg {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // conversion to Result&lt;HandleResponse, StakingError&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HandleMsg::Bond {} =&gt; Ok(bond(deps, env)?),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        // this already returns Result&lt;HandleResponse, StakingError&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        HandleMsg::_BondAllTokens {} =&gt; _bond_all_tokens(deps, env),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>or</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init&lt;S: Storage, A: Api, Q: Querier&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: &amp;mut Extern&lt;S, A, Q&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: InitMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) -&gt; Result&lt;InitResponse, HackError&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // â€¦</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ctx.add_attribute(&quot;Let the&quot;, &quot;hacking begin&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Ok(ctx.try_into()?)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Once you got familiar with the concept, you can create different error types
for each of the contract&#x27;s functions.</p><p>You can also try a different error library than
<a href="https://crates.io/crates/thiserror" target="_blank" rel="noopener noreferrer">thiserror</a>. The
<a href="https://github.com/CosmWasm/cosmwasm/tree/master/contracts/staking" target="_blank" rel="noopener noreferrer">staking development contract</a>
shows how this would look like using <a href="https://crates.io/crates/snafu" target="_blank" rel="noopener noreferrer">snafu</a>.</p></li><li><p>Change order of arguments such that <code>storage</code> is always first followed by
namespace in <code>Bucket::new</code>, <code>Bucket::multilevel</code>, <code>ReadonlyBucket::new</code>,
<code>ReadonlyBucket::multilevel</code>, <code>PrefixedStorage::new</code>,
<code>PrefixedStorage::multilevel</code>, <code>ReadonlyPrefixedStorage::new</code>,
<code>ReadonlyPrefixedStorage::multilevel</code>, <code>bucket</code>, <code>bucket_read</code>, <code>prefixed</code> and
<code>prefixed_read</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut bucket = bucket::&lt;_, Data&gt;(b&quot;data&quot;, &amp;mut store);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut bucket = bucket::&lt;_, Data&gt;(&amp;mut store, b&quot;data&quot;);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Rename <code>InitResponse::log</code>, <code>MigrateResponse::log</code> and <code>HandleResponse::log</code>
to <code>InitResponse::attributes</code>, <code>MigrateResponse::attributes</code> and
<code>HandleResponse::attributes</code>. Replace calls to <code>log</code> with <code>attr</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Ok(HandleResponse {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  log: vec![log(&quot;action&quot;, &quot;change_owner&quot;), log(&quot;owner&quot;, owner)],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ..HandleResponse::default()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Ok(HandleResponse {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  attributes: vec![attr(&quot;action&quot;, &quot;change_owner&quot;), attr(&quot;owner&quot;, owner)],</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ..HandleResponse::default()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Rename <code>Context::add_log</code> to <code>Context::add_attribute</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_log(&quot;action&quot;, &quot;release&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_log(&quot;destination&quot;, &amp;to_addr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut ctx = Context::new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_attribute(&quot;action&quot;, &quot;release&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">ctx.add_attribute(&quot;destination&quot;, &amp;to_addr);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Add result type to <code>Bucket::update</code> and <code>Singleton::update</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bucket.update(b&quot;maria&quot;, |mayd: Option&lt;Data&gt;| {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  let mut d = mayd.ok_or(StdError::not_found(&quot;Data&quot;))?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  old_age = d.age;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  d.age += 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Ok(d)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">bucket.update(b&quot;maria&quot;, |mayd: Option&lt;Data&gt;| -&gt; StdResult&lt;_&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  let mut d = mayd.ok_or(StdError::not_found(&quot;Data&quot;))?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  old_age = d.age;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  d.age += 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Ok(d)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Remove all <code>canonical_length</code> arguments from mock APIs in tests:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = mock_dependencies(20, &amp;[]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = mock_dependencies(20, &amp;coins(123456, &quot;gold&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let deps = mock_dependencies_with_balances(20, &amp;[(&amp;rich_addr, &amp;rich_balance)]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let api = MockApi::new(20);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = mock_dependencies(&amp;[]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = mock_dependencies(&amp;coins(123456, &quot;gold&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let deps = mock_dependencies_with_balances(&amp;[(&amp;rich_addr, &amp;rich_balance)]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let api = MockApi::default();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Add <code>MessageInfo</code> as separate arg after <code>Env</code> for <code>init</code>, <code>handle</code>, <code>migrate</code>.
Add <code>Env</code> arg to <code>query</code>. Use <code>info.sender</code> instead of <code>env.message.sender</code>
and <code>info.sent_funds</code> rather than <code>env.message.sent_funds</code>. Just changing the
function signatures of the 3-4 export functions should be enough, then the
compiler will warn you anywhere you use <code>env.message</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init&lt;S: Storage, A: Api, Q: Querier&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: &amp;mut Extern&lt;S, A, Q&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: InitMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps.storage.set(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CONFIG_KEY,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;to_vec(&amp;State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            verifier: deps.api.canonical_address(&amp;msg.verifier)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            beneficiary: deps.api.canonical_address(&amp;msg.beneficiary)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            funder: deps.api.canonical_address(&amp;env.message.sender)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">pub fn init&lt;S: Storage, A: Api, Q: Querier&gt;(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps: &amp;mut Extern&lt;S, A, Q&gt;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    _env: Env,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    info: MessageInfo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    msg: InitMsg,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    deps.storage.set(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        CONFIG_KEY,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        &amp;to_vec(&amp;State {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            verifier: deps.api.canonical_address(&amp;msg.verifier)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            beneficiary: deps.api.canonical_address(&amp;msg.beneficiary)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            funder: deps.api.canonical_address(&amp;info.sender)?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        })?,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Test code now has <code>mock_info</code> which takes the same args <code>mock_env</code> used to.
You can just pass <code>mock_env()</code> directly into the function calls unless you
need to change height/time.</p></li><li><p>One more object to pass in for both unit and integration tests. To do this
quickly, I just highlight all copies of <code>env</code> and replace them with <code>info</code>
(using Ctrl+D in VSCode or Alt+J in IntelliJ). Then I select all <code>deps, info</code>
sections and replace that with <code>deps, mock_env(), info</code>. This fixes up all
<code>init</code> and <code>handle</code> calls, then just add an extra <code>mock_env()</code> to the query
calls.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before: unit test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(creator.as_str(), &amp;[]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let res = init(&amp;mut deps, env, msg).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let query_response = query(&amp;deps, QueryMsg::Verifier {}).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after: unit test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info = mock_info(creator.as_str(), &amp;[]);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let res = init(&amp;mut deps, mock_env(), info, msg).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let query_response = query(&amp;deps, mock_env(), QueryMsg::Verifier {}).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before: integration test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(&quot;creator&quot;, &amp;coins(1000, &quot;earth&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let res: InitResponse = init(&amp;mut deps, env, msg).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let query_response = query(&amp;mut deps, QueryMsg::Verifier {}).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after: integration test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let info = mock_info(&quot;creator&quot;, &amp;coins(1000, &quot;earth&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let res: InitResponse = init(&amp;mut deps, mock_env(), info, msg).unwrap();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let query_response = query(&amp;mut deps, mock_env(), QueryMsg::Verifier {}).unwrap();</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="09---010"></a>0.9 -&gt; 0.10<a class="hash-link" href="#09---010" title="Direct link to heading">#</a></h2><ul><li><p>Update CosmWasm dependencies in Cargo.toml (skip the ones you don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.10.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.10.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.10.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.10.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>Integration tests:</p><ul><li><p>Calls to <code>Api::human_address</code> and <code>Api::canonical_address</code> now return a pair
of result and gas information. Change</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">verifier: deps.api.canonical_address(&amp;verifier).unwrap(),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">verifier: deps.api.canonical_address(&amp;verifier).0.unwrap(),</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>The same applies for all calls of <code>Querier</code> and <code>Storage</code>.</p></li></ul><p>All Tests:</p><p>All usages of <code>mock_env</code> will have to remove the first argument (no need of
API).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(&amp;deps.api, &quot;creator&quot;, &amp;coins(1000, &quot;earth&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(&quot;creator&quot;, &amp;coins(1000, &quot;earth&quot;));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Contracts:</p><ul><li>All code that uses <code>message.sender</code> or <code>contract.address</code> should deal with
<code>HumanAddr</code> not <code>CanonicalAddr</code>. Many times this means you can remove a
conversion step.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="08---09"></a>0.8 -&gt; 0.9<a class="hash-link" href="#08---09" title="Direct link to heading">#</a></h2><ul><li><p>Update CosmWasm dependencies in Cargo.toml (skip the ones you don&#x27;t use):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-std = &quot;0.9.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-storage = &quot;0.9.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">[dev-dependencies]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-schema = &quot;0.9.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm-vm = &quot;0.9.0&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"># ...</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p><code>lib.rs</code>:</p><ul><li><p>The C export boilerplate can now be reduced to the following code (see e.g. in
<a href="https://github.com/CosmWasm/cosmwasm/blob/0a5b3e8121/contracts/hackatom/src/lib.rs" target="_blank" rel="noopener noreferrer">hackatom/src/lib.rs</a>):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">mod contract; // contains init, handle, query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// maybe additional modules here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#[cfg(target_arch = &quot;wasm32&quot;)]</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cosmwasm_std::create_entry_points!(contract);</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>Contract code and uni tests:</p><ul><li><code>cosmwasm_storage::get_with_prefix</code>, <code>cosmwasm_storage::set_with_prefix</code>,
<code>cosmwasm_storage::RepLog::commit</code>, <code>cosmwasm_std::ReadonlyStorage::get</code>,
<code>cosmwasm_std::ReadonlyStorage::range</code>, <code>cosmwasm_std::Storage::set</code> and
<code>cosmwasm_std::Storage::remove</code> now return the value directly that was wrapped
in a result before.</li><li>Error creator functions are now in type itself, e.g.
<code>StdError::invalid_base64</code> instead of <code>invalid_base64</code>. The free functions are
deprecated and will be removed before 1.0.</li><li>Remove <code>InitResponse.data</code> in <code>init</code>. Before 0.9 this was not stored to chain
but ignored.</li><li>Use <code>cosmwasm_storage::transactional</code> instead of the removed
<code>cosmwasm_storage::transactional_deps</code>.</li><li>Replace <code>cosmwasm_std::Never</code> with <code>cosmwasm_std::Empty</code>.</li></ul><p>Integration tests:</p><ul><li>Replace <code>cosmwasm_vm::ReadonlyStorage</code> with <code>cosmwasm_vm::Storage</code>, which now
contains all backend storage methods.</li><li>Storage getters (and iterators) now return a result of
<code>(Option&lt;Vec&lt;u8&gt;&gt;, u64)</code>, where the first component is the element and the
second one is the gas cost. Thus in a few places <code>.0</code> must be added to access
the element.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="072---08"></a>0.7.2 -&gt; 0.8<a class="hash-link" href="#072---08" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-wasm-code"></a>Update wasm code<a class="hash-link" href="#update-wasm-code" title="Direct link to heading">#</a></h3><p><code>Cargo.toml</code> dependencies:</p><ul><li>Update to <code>schemars = &quot;0.7&quot;</code></li><li>Replace <code>cosmwasm = &quot;0.7&quot;</code> with <code>cosmwasm-std = &quot;0.8&quot;</code></li><li>Replace <code>cosmwasm-vm = &quot;0.7&quot;</code> with <code>cosmwasm-vm = &quot;0.8&quot;</code></li><li>Replace <code>cw-storage = &quot;0.2&quot;</code> with <code>cosmwasm-storage = &quot;0.8&quot;</code></li><li>Remove explicit <code>snafu</code> dependency. <code>cosmwasm_std</code> still uses it internally
but doesn&#x27;t expose snafu specifics anymore. See more details on errors below.</li></ul><p>(Note: until release of <code>0.8</code>, you need to use git references for all
<code>cosmwasm_*</code> packages)</p><p><code>Cargo.toml</code> features:</p><ul><li>Replace <code>&quot;cosmwasm/backtraces&quot;</code> with <code>&quot;cosmwasm-std/backtraces&quot;</code></li></ul><p>Imports:</p><ul><li>Replace all <code>use cosmwasm::X::Y</code> with <code>use cosmwasm_std::Y</code>, except for mock</li><li>Replace all <code>use cosmwasm::mock::Y</code> with <code>use cosmwasm_std::testing::Y</code>. This
should only be used in test code.</li><li>Replace <code>cw_storage:X</code> with <code>cosmwasm_storage::X</code></li><li>Replace <code>cosmwasm_std::Response</code> with <code>cosmwasm_std::HandleResponse</code> and
<code>cosmwasm_std::InitResponse</code> (different type for each call)</li></ul><p><code>src/lib.rs</code>:</p><p>This has been re-written, but is generic boilerplate and should be (almost) the
same in all contracts:</p><ul><li>copy the new version from
<a href="https://github.com/CosmWasm/cosmwasm/blob/master/contracts/queue/src/lib.rs" target="_blank" rel="noopener noreferrer"><code>contracts/queue</code></a></li><li>Add <code>pub mod XYZ</code> directives for any modules you use besides <code>contract</code></li></ul><p>Contract Code:</p><ul><li><p>Add query to extern:</p><ul><li>Before: <code>my_func&lt;S: Storage, A: Api&gt;(deps: &amp;Extern&lt;S, A&gt;, ...</code></li><li>After: <code>my_func&lt;S: Storage, A: Api, Q: Querier&gt;(deps: &amp;Extern&lt;S, A, Q&gt;, ...</code></li><li>Remember to add <code>use cosmwasm_std::Querier;</code></li></ul></li><li><p><code>query</code> now returns <code>StdResult&lt;Binary&gt;</code> instead of <code>Result&lt;Vec&lt;u8&gt;&gt;</code></p><ul><li>You can also replace <code>to_vec(...)</code> with <code>to_binary(...)</code></li></ul></li><li><p>No <code>.context(...)</code> is required after <code>from_slice</code> and <code>to_vec</code>, they return
proper <code>cosmwasm_std::Error</code> variants on errors.</p></li><li><p><code>env.message.signer</code> becomes <code>env.message.sender</code>.</p></li><li><p>If you used <code>env.contract.balance</code>, you must now use the querier. The
following code block should work:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before (in env)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let foo = env.contract.balance;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after (query my balance)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let contract_addr = deps.api.human_address(&amp;env.contract.address)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let balance = deps.querier.query_all_balances(&amp;contract_addr)?;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let foo = balance.amount;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Update the <code>CosmosMsg</code> enums used:</p><ul><li><code>CosmosMsg::Send{}</code> =&gt; <code>CosmosMsg::Bank(BankMsg::Send{})</code></li><li><code>CosmosMsg::Opaque{ data }</code> =&gt; <code>CosmosMsg::Native{ msg }</code></li><li><code>CosmosMsg::Contract</code> =&gt; <code>CosmosMsg::Wasm(WasmMsg::Execute{})</code></li></ul></li><li><p>Complete overhaul of <code>cosmwasm::Error</code> into <code>cosmwasm_std::StdError</code>:</p><ul><li>Auto generated snafu error constructor structs like <code>NotFound</code>/<code>ParseErr</code>/â€¦
have been privatized in favour of error generation helpers like
<code>not_found</code>/<code>parse_err</code>/â€¦</li><li>All error generator functions now return errors instead of results, such
that e.g. <code>return unauthorized();</code> becomes <code>return Err(unauthorized());</code></li><li>Error cases don&#x27;t contain <code>source</code> fields anymore. Instead source errors are
converted to standard types like <code>String</code>. For this reason, both
<code>snafu::ResultExt</code> and <code>snafu::OptionExt</code> cannot be used anymore. An error
wrapper now looks like <code>.map_err(invalid_base64)</code> and an <code>Option::None</code> to
error mapping looks like <code>.ok_or_else(|| not_found(&quot;State&quot;))</code>.</li><li>Backtraces became optional. Use <code>RUST_BACKTRACE=1</code> to enable them for unit
tests.</li><li><code>Utf8Err</code>/<code>Utf8StringErr</code> merged into <code>StdError::InvalidUtf8</code></li><li><code>Base64Err</code> renamed into <code>StdError::InvalidBase64</code></li><li><code>ContractErr</code>/<code>DynContractErr</code> merged into <code>StdError::GenericErr</code>, thus both
<code>contract_err</code> and <code>dyn_contract_err</code> must be replaced with <code>generic_err</code>.</li><li>The unused <code>ValidationErr</code> was removed</li></ul></li></ul><p>At this point <code>cargo wasm</code> should pass.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-test-code"></a>Update test code<a class="hash-link" href="#update-test-code" title="Direct link to heading">#</a></h3><p>Both:</p><ul><li><p>Update all imports from <code>cosmwasm::mock::*</code> to <code>cosmwasm_std::testing::*</code></p></li><li><p>Use <code>from_binary</code> not <code>from_slice</code> on all query responses (update imports)</p><ul><li><code>from_slice(res.as_slice())</code> -&gt; <code>from_binary(&amp;res)</code></li></ul></li><li><p>Replace <code>coin(&quot;123&quot;, &quot;FOO&quot;)</code> with <code>coins(123, &quot;FOO&quot;)</code>. We renamed it to coins
to be more explicit that it returns <code>Vec&lt;Coin&gt;</code>, and now accept a <code>u128</code> as
the first argument for better type-safety. <code>coin</code> is now an alias to
<code>Coin::new</code> and returns one <code>Coin</code>.</p></li><li><p>Remove the 4th argument (contract balance) from all calls to <code>mock_env</code>, this
is no longer stored in the environment.</p></li><li><p><code>dependencies</code> was renamed to <code>mock_dependencies</code>. <code>mock_dependencies</code> and
<code>mock_instance</code> take a 2nd argument to set the contract balance (visible for
the querier). If you need to set more balances, use <code>mock_XX_with_balances</code>.
The follow code block explains:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly rust"><div tabindex="0" class="prism-code language-rust codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// before: balance as last arg in mock_env</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = dependencies(20);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(&amp;deps.api, &quot;creator&quot;, &amp;coins(15, &quot;earth&quot;), &amp;coins(1015, &quot;earth&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// after: balance as last arg in mock_dependencies</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let mut deps = mock_dependencies(20, &amp;coins(1015, &quot;earth&quot;));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">let env = mock_env(&amp;deps.api, &quot;creator&quot;, &amp;coins(15, &quot;earth&quot;));</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ul><p>Unit Tests:</p><ul><li>Replace <code>dependencies</code> with <code>mock_dependencies</code></li></ul><p>Integration Tests:</p><ul><li>We no longer check errors as strings but have rich types:<ul><li>Before:
<code>match err { ContractResult::Err(msg) =&gt; assert_eq!(msg, &quot;Unauthorized&quot;), ... }</code></li><li>After: <code>match err { Err(StdError::Unauthorized{ .. }) =&gt; {}, ... }</code></li></ul></li><li>Remove all imports / use of <code>ContractResult</code></li><li>You must specify <code>CosmosMsg::Native</code> type when calling
<code>cosmwasm_vm::testing::{handle, init}</code>. You will want to
<code>use cosmwasm_std::{HandleResult, InitResult}</code> or
<code>use cosmwasm_std::{HandleResponse, InitResponse}</code>. If you don&#x27;t use custom
native types, simply update calls as follows:<ul><li><code>let res = init(...)</code> =&gt; <code>let res: InitResult = init(...)</code></li><li><code>let res = init(...).unwrap()</code> =&gt;
<code>let res: InitResponse = init(...).unwrap()</code></li><li><code>let res = handle(...)</code> =&gt; <code>let res: HandleResult = handle(...)</code></li><li><code>let res = handle(...).unwrap()</code> =&gt;
<code>let res: HandleResponse = handle(...).unwrap()</code></li></ul></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="update-schema-code"></a>Update schema code<a class="hash-link" href="#update-schema-code" title="Direct link to heading">#</a></h3><p>All helper functions have been moved into a new <code>cosmwasm-schema</code> package.</p><ul><li>Add <code>cosmwasm-schema = &quot;0.8&quot;</code> to <code>[dev-dependencies]</code> in <code>Cargo.toml</code></li><li>Remove <code>serde_json</code> <code>[dev-dependency]</code> if there, as cosmwasm-schema will
handle JSON output internally.</li><li>Update <code>examples/schema.rs</code> to look
<a href="https://github.com/CosmWasm/cosmwasm/blob/master/contracts/queue/examples/schema.rs" target="_blank" rel="noopener noreferrer">more like queue</a>,
but replacing all the imports and type names with those you currently have.</li><li>Regenerate schemas with <code>cargo schema</code></li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="polishing"></a>Polishing<a class="hash-link" href="#polishing" title="Direct link to heading">#</a></h3><p>After so many changes, remember to let the linters do their jobs.</p><ul><li><code>cargo fmt</code></li><li><code>cargo clippy</code></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/CosmWasm/docs/edit/master/docs/learn/MIGRATING.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/0.14/learn/videos-workshops"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Videos and Workshops</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/0.14/learn/CHANGELOG"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CHANGELOG Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#013---014" class="table-of-contents__link">0.13 -&gt; 0.14</a></li><li><a href="#012---013" class="table-of-contents__link">0.12 -&gt; 0.13</a></li><li><a href="#011---012" class="table-of-contents__link">0.11 -&gt; 0.12</a></li><li><a href="#010---011" class="table-of-contents__link">0.10 -&gt; 0.11</a></li><li><a href="#09---010" class="table-of-contents__link">0.9 -&gt; 0.10</a></li><li><a href="#08---09" class="table-of-contents__link">0.8 -&gt; 0.9</a></li><li><a href="#072---08" class="table-of-contents__link">0.7.2 -&gt; 0.8</a><ul><li><a href="#update-wasm-code" class="table-of-contents__link">Update wasm code</a></li><li><a href="#update-test-code" class="table-of-contents__link">Update test code</a></li><li><a href="#update-schema-code" class="table-of-contents__link">Update schema code</a></li><li><a href="#polishing" class="table-of-contents__link">Polishing</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Related Documentation</h4><ul class="footer__items"><li class="footer__item"><a href="https://cosmos.network/docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos SDK</a></li><li class="footer__item"><a href="https://hub.cosmos.network/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cosmos Hub</a></li><li class="footer__item"><a href="https://docs.tendermint.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Tendermint Core</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Repositories</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/CosmWasm/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmWasm/cosmwasm</a></li><li class="footer__item"><a href="https://github.com/CosmWasm/wasmd" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmWasm/wasmd</a></li><li class="footer__item"><a href="https://github.com/CosmWasm/cosmwasm-plus" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmWasm/cosmwasm-plus</a></li><li class="footer__item"><a href="https://github.com/CosmWasm/cawesome-wasm" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmWasm/cawesome-wasm</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://medium.com/confio" target="_blank" rel="noopener noreferrer" class="footer__link-item">Confio Blog</a></li><li class="footer__item"><a href="https://docs.cosmwasm.com/chat/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://twitter.com/CosmWasm" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://cosmwasm.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_MyFc"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/logo_stacked.png" alt="CosmWasm Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2021 Confio OÃœ</div></div></div></footer></div>
<script src="/assets/js/runtime~main.74a0419b.js"></script>
<script src="/assets/js/main.435ff634.js"></script>
</body>
</html>